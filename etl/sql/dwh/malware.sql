--TRUNCATE dwh.malware;

DROP TABLE IF EXISTS malware_temp;

DO $$

DECLARE
    dwh_etl_timestamp timestamp;
BEGIN
    dwh_etl_timestamp := (SELECT MAX(etl_timestamp) FROM dwh.malware);


    CREATE TEMP TABLE malware_temp AS
        SELECT DISTINCT
            a.url
        FROM datalake.malware AS a
        WHERE a.etl_timestamp >= COALESCE(dwh_etl_timestamp, a.etl_timestamp)
        ;


    INSERT INTO dwh.malware (
        hash_key_url,
        etl_timestamp
    )
    SELECT
        MD5(COALESCE(url, ''))::UUID AS hash_key_url,
--         '2023-12-12 14:36:18.302419 +00:00'::TIMESTAMPTZ
        '{{ etl_timestamp }}'::TIMESTAMPTZ AS etl_timestamp
    FROM malware_temp
    ;

END;
$$;

DROP TABLE IF EXISTS malware_temp;

-- Return Result Row Count:
SELECT COUNT(*) FROM dwh.malware;
